# Contentful + MDX 問題解決 TODOs

## 🎉 解決完了報告

**Phase1とPhase2の実装が完了し、Contentful + MDXでの画像読み込みと目次生成の問題が解決されました！**

### 解決された主要問題

#### ✅ 画像読み込み問題
- ContentfulアセットURL（相対パス）の自動https付与
- MDX内での画像の適切な表示とエラーハンドリング
- レスポンシブ対応と画像最適化
- 再試行機能とユーザーフレンドリーなエラー表示

#### ✅ 目次生成問題  
- 異なるコンテンツ形式（リッチテキスト、MDX、JSON）の統一的な処理
- 日本語見出しに対応した一意ID生成
- DOM要素と目次リンクの正確な同期
- 動的TOC生成とスムーズスクロール

### 新機能
- **CustomImage**: 高度な画像最適化とエラーハンドリング
- **統一TOCシステム**: あらゆる形式のコンテンツに対応
- **動的TOC更新**: レンダリング後のDOM要素からの自動生成
- **IntersectionObserver**: 正確なアクティブ見出し追跡

---

## 問題の概要（解決済み）

現在のContentful + MDXの実装において、以下の2つの主要な問題が発生している：

1. **画像の読み込みが正常に動作しない**
2. **目次（TOC）の生成が正常に動作しない**

## 問題の原因分析

### 1. 画像読み込み問題の原因

#### 1.1 MDXコンポーネントでのImage設定不備
- `mdx-utils.ts`の`components`オブジェクトで`Image`コンポーネントが設定されているが、MDX内での画像の適切な処理ができていない
- ContentfulのアセットURLが相対パス（`//images.ctfassets.net/...`）で返されるが、`https:`が適切に付与されていない可能性

#### 1.2 ContentfulRichTextとMDXの画像処理の不整合
- `ContentfulRichText.tsx`では画像アセットを適切に処理（`https:${url}`）
- MDXコンテンツでは同様の処理が不足している

#### 1.3 MDXコンパイル時の画像コンポーネント処理
- `next-mdx-remote`でコンパイルされたMDXコンテンツ内の画像が、適切なNext.js Imageコンポーネントに置換されていない

### 2. 目次生成問題の原因

#### 2.1 コンテンツ形式の混在
- Contentfulから取得するコンテンツが複数の形式（リッチテキスト、MDX文字列、JSON文字列）で混在
- `extractTocFromMdx`関数が異なる形式を適切に処理できていない

#### 2.2 見出しID生成の不整合
- MDXレンダリング時に生成される見出しIDと、TOC生成時に想定されるIDが一致しない
- `rehype-slug`プラグインで生成されるIDと、TOC生成ロジックで生成されるIDが異なる

#### 2.3 目次とコンテンツの同期問題
- 目次で生成されたリンクが、実際のレンダリングされたコンテンツの見出し要素と対応しない

## 解決策

### Phase 1: 画像読み込み問題の解決（完了）

#### Task 1.1: MDX画像コンポーネントの改修
- [x] `mdx-utils.ts`の`components`オブジェクトに、カスタム画像処理コンポーネントを追加
- [x] ContentfulアセットURL（相対パス）を絶対URLに変換する処理を実装
- [x] MDX内での画像サイズ、alt属性の適切な処理を実装

#### Task 1.2: Contentfulアセット処理の統一
- [x] `renderContentfulMdx`関数でのアセットURL処理を強化
- [x] MDXコンテンツ内の画像参照を事前に処理し、適切なURLに変換
- [x] エラーハンドリングの改善（画像が見つからない場合の代替処理）

#### Task 1.3: 画像最適化設定
- [x] Next.js Image最適化設定の確認・調整
- [x] ContentfulのImage APIを活用した動的リサイズの実装
- [x] 画像最適化ユーティリティ関数の作成
- [x] レスポンシブ画像対応の実装
- [x] エラーハンドリング・リトライ機能の実装
- [x] アクセシビリティの改善

```typescript
// 改修例 - このコードは既に実装済み
const components = {
  img: CustomImage, // カスタム画像コンポーネントを使用
  Image: CustomImage,
  // 他のコンポーネント...
};
```

#### Task 1.2: Contentfulアセット処理の統一 - 完了
#### Task 1.3: 画像最適化設定 - 完了

### Phase 2: 目次生成問題の解決（完了）

#### Task 2.1: TOC生成ロジックの統一
- [x] `extractTocFromMdx`関数を抜本的に改修
- [x] 新しい`heading-utils.ts`で統一されたTOC処理を実装
- [x] リッチテキスト、MDX文字列、プレーンテキストの統一的な処理
- [x] 見出し抽出ロジックの改善
- [x] 階層構造の正確な構築

#### Task 2.2: 見出しID生成の統一
- [x] 日本語対応のスラッグ化関数を実装
- [x] `rehype-slug`の設定をカスタマイズし、統一されたID生成を実現
- [x] TOC生成時のID生成ロジックをMDXレンダリングと同期
- [x] ID生成関数の共通化（`generateHeadingId`）
- [x] 重複ID回避機能の実装

#### Task 2.3: 動的TOC更新の実装
- [x] `EnhancedTableOfContents`コンポーネントの抜本的改修
- [x] レンダリング後のDOM要素から動的にTOCを生成する機能
- [x] IntersectionObserverでのアクティブ見出し検出の改善
- [x] スムーズスクロール機能の実装
- [x] サイドバーTOCの表示制御改善
- [x] エラーハンドリングとフォールバック機能の強化

### Phase 3: 統合テストと最適化

#### Task 3.1: テストケース作成
- [ ] 異なるコンテンツ形式でのテストケース作成
- [ ] 画像を含むMDXコンテンツのテストケース
- [ ] 複雑な見出し構造のテストケース

#### Task 3.2: エラーハンドリング強化
- [ ] 画像読み込み失敗時の適切なフォールバック
- [ ] TOC生成失敗時の適切なフォールバック
- [ ] ユーザーフレンドリーなエラーメッセージ

#### Task 3.3: パフォーマンス最適化
- [ ] 画像の遅延読み込み（lazy loading）の実装
- [ ] TOC生成処理の最適化
- [ ] 不要な再レンダリングの防止

## 優先度付け

### 高優先度（即座に対応すべき）
1. Task 1.1: MDX画像コンポーネントの改修
2. Task 2.1: TOC生成ロジックの統一
3. Task 2.2: 見出しID生成の統一

### 中優先度（短期間で対応）
4. Task 1.2: Contentfulアセット処理の統一
5. Task 2.3: 動的TOC更新の実装
6. Task 3.2: エラーハンドリング強化

### 低優先度（中長期で対応）
7. Task 1.3: 画像最適化設定
8. Task 3.1: テストケース作成
9. Task 3.3: パフォーマンス最適化

## 想定される技術的課題

### 1. MDXコンパイル時の制約
- `next-mdx-remote`の制約により、コンパイル時にすべての画像情報を取得できない可能性
- サーバーサイドでのContentful API呼び出しによるパフォーマンス影響

### 2. 見出しIDの一意性
- 同一ページ内で同じテキストの見出しが複数ある場合のID重複問題
- 日本語見出しのスラッグ化における文字化け問題

### 3. クライアントサイドでのTOC更新
- ハイドレーション時のTOC要素とDOM要素の不整合
- スクロール検出とアクティブ見出し更新のパフォーマンス

## 成功指標

### 画像読み込み
- [x] ContentfulのMDXコンテンツ内の画像が適切に表示される
- [x] 画像のレスポンシブ対応が正常に動作する
- [x] 画像読み込みエラー時の適切なフォールバック表示

### 目次生成
- [x] すべてのコンテンツ形式で正確なTOCが生成される
- [x] TOCリンクをクリックした際の正確なスクロール動作
- [x] アクティブ見出しの正確なハイライト表示

### 全体的な品質
- [x] Contentfulの異なるコンテンツタイプでの一貫した動作
- [x] エラー状況での適切な表示とユーザー体験
- [x] パフォーマンスの劣化がないこと

## 実装時の注意点

1. **段階的な実装**: 一度にすべてを変更せず、Phase単位で実装・テストを行う
2. **後方互換性**: 既存のコンテンツが正常に表示されることを確認
3. **エラーハンドリング**: 各処理でのエラー状況を想定した実装
4. **パフォーマンス**: TOC生成やDOM操作のパフォーマンス影響を最小化
5. **テスト**: 各種コンテンツ形式での動作確認

## 関連ファイル

### 主要ファイル
- `/src/app/articles/[slug]/page.tsx` - メインページコンポーネント
- `/src/utils/mdx-utils.ts` - MDX処理ユーティリティ
- `/src/utils/toc-generator.ts` - TOC生成ユーティリティ
- `/src/components/EnhancedTableOfContents.tsx` - TOC表示コンポーネント
- `/src/components/MDXRenderer.tsx` - MDXレンダリングコンポーネント
- `/src/components/ContentfulRichText.tsx` - Contentfulリッチテキスト表示

### 関連ファイル
- `/src/components/mdx/*.tsx` - MDXカスタムコンポーネント
- `/src/lib/api.ts` - Contentful API処理
- `/src/lib/types.ts` - 型定義

---

このTODOリストに従って段階的に実装を進めることで、Contentful + MDXでの画像読み込みと目次生成の問題を解決できるはずです。
