# MDXレンダリングシステム仕様書

## 1. 概要

本仕様書は、ビジネススキル百科サイトにおけるMDXレンダリングシステムの実装仕様を定義するものです。このシステムは、Contentfulから取得したMDXコンテンツを適切にレンダリングし、記事、動画、音声などの異なるコンテンツタイプに対応した表示を提供します。また、目次の表示や広告の挿入など、ユーザーエクスペリエンスを向上させる機能も含まれています。

## 2. 目的

- MDXファイルが見つからないエラーの解決
- 動画や音声コンテンツに追加解説記事を含める機能の提供
- コンテンツ管理の効率化
- 目次表示の改善（全デバイス共通の目次とフローティングサイドバー目次）
- 広告の挿入機能の提供
- ユーザーエクスペリエンスの向上

## 3. システム構成

### 3.1 コンポーネント構成

- **MDXユーティリティ関数**: MDXコンテンツの取得とレンダリングを行う
- **MDXコンポーネント**:
  - Callout: 注意書きや情報ボックスを表示する
  - CodeBlock: コードブロックを表示する
  - AdPlacement: 広告を表示する
- **目次コンポーネント**:
  - EnhancedTableOfContents: 記事の目次を表示する（メインとサイドバーの2種類）
- **メディアプレーヤーコンポーネント**: 動画や音声を再生するためのコンポーネント
- **関連コンテンツコンポーネント**: 関連するコンテンツを表示するコンポーネント
- **広告コンポーネント**: 広告を表示するコンポーネント
- **ページコンポーネント**: 各コンテンツタイプのページを表示するコンポーネント

### 3.2 データフロー

1. ユーザーがURLにアクセス
2. Next.jsがページコンポーネントをレンダリング
3. ページコンポーネントがContentfulからコンテンツを取得
4. MDXユーティリティ関数がMDXコンテンツをレンダリング
5. レンダリングされたコンテンツがページに表示される

## 4. 機能仕様

### 4.1 MDXレンダリング

#### 4.1.1 MDXコンテンツの取得

- Contentfulから特定のスラッグのコンテンツを取得
- コンテンツタイプ（記事、動画、音声）に応じたフィルタリング
- 関連コンテンツの取得

#### 4.1.2 MDXコンテンツのレンダリング

- next-mdx-remote/rscを使用してMDXコンテンツをレンダリング
- カスタムMDXコンポーネントの適用
- フロントマターの解析と使用

### 4.2 目次表示

#### 4.2.1 メイン目次

- 記事の先頭に表示される目次
- すべてのデバイスで表示
- 見出しレベルに応じた階層構造
- クリックで該当セクションにスムーズスクロール

#### 4.2.2 サイドバー目次

- PCのみ表示される右サイドバーの目次
- メイン目次が画面外に出たときにフェードインして表示
- 画面スクロールに追従する固定表示
- アクティブな見出しのハイライト表示

### 4.3 広告表示

#### 4.3.1 インライン広告

- MDXコンテンツ内に挿入される広告
- `<AdPlacement />` コンポーネントを使用して配置
- 広告IDを指定して特定の広告を表示可能

#### 4.3.2 サイドバー広告

- 右サイドバーに表示される広告
- 目次の下に配置
- PCのみ表示

#### 4.3.3 フッター広告

- 記事の最後に表示される広告
- すべてのデバイスで表示

### 4.4 コンテンツタイプ別の表示

#### 4.4.1 記事ページ

- 記事タイトル、説明、メタ情報の表示
- MDXコンテンツの表示
- 目次の生成と表示（メインとサイドバー）
- 広告の表示（インライン、サイドバー、フッター）
- 関連コンテンツの表示

#### 4.4.2 動画ページ

- 動画タイトル、説明、メタ情報の表示
- 動画プレーヤーの表示
- MDXコンテンツによる解説の表示
- 関連コンテンツの表示

#### 4.4.3 音声ページ

- 音声タイトル、説明、メタ情報の表示
- 音声プレーヤーの表示
- MDXコンテンツによる解説の表示
- 関連コンテンツの表示

### 4.5 エラーハンドリング

- Contentfulからのコンテンツ取得に失敗した場合のフォールバック
- MDXレンダリングに失敗した場合のエラー表示
- 存在しないコンテンツへのアクセス時の404ページ表示

## 5. コンポーネント仕様

### 5.1 MDXコンポーネント

#### 5.1.1 Calloutコンポーネント

- タイプ: info, warning, success, error
- タイトルとコンテンツの表示
- スタイリング: 背景色、アイコン、ボーダー

#### 5.1.2 CodeBlockコンポーネント

- シンタックスハイライト
- 言語表示
- コピーボタン

#### 5.1.3 AdPlacementコンポーネント

- 広告IDの指定
- 表示位置の指定（inline, sidebar, footer）
- MDXコンテンツ内での広告表示

### 5.2 目次コンポーネント

#### 5.2.1 EnhancedTableOfContentsコンポーネント

- タイプ: main（メイン目次）, sidebar（サイドバー目次）
- 見出しレベルに応じた階層表示
- アクティブな見出しのハイライト
- スクロール追従（サイドバー目次）
- フェードイン/フェードアウト効果（サイドバー目次）

### 5.3 広告コンポーネント

#### 5.3.1 Advertisementコンポーネント

- 表示位置: inline, sidebar, footer
- 広告コード（HTMLコード）または広告データ（タイトル、説明、画像、リンク）の表示
- レスポンシブデザイン
- クライアントサイドレンダリング

### 5.4 メディアプレーヤーコンポーネント

#### 5.4.1 VideoPlayerコンポーネント

- YouTube埋め込み対応
- レスポンシブデザイン
- エラーハンドリング

#### 5.4.2 AudioPlayerコンポーネント

- 再生/一時停止コントロール
- シークバー
- 時間表示

### 5.5 RelatedContentsコンポーネント

- コンテンツタイプに応じたカード表示
- サムネイル画像の表示
- タイトルと説明の表示
- 適切なリンク先の設定

## 6. API仕様

### 6.1 Contentful API

#### 6.1.1 getContentBySlug

- パラメータ: slug, contentType
- 戻り値: Content | null

#### 6.1.2 getRelatedContents

- パラメータ: contentId
- 戻り値: Content[]

### 6.2 MDXユーティリティ関数

#### 6.2.1 renderContentfulMdx

- パラメータ: slug, contentType
- 戻り値: { slug, frontMatter, content, mdxContent, relatedContents }

#### 6.2.2 getMdxBySlug

- パラメータ: slug
- 戻り値: { slug, frontMatter, content }

## 7. デザイン仕様

### 7.1 レイアウト

- デスクトップ: 2カラムレイアウト（コンテンツ + サイドバー）
- モバイル: 1カラムレイアウト（コンテンツのみ）

### 7.2 カラースキーム

- 記事: from-blue-400 via-sky-500 to-indigo-600
- 動画: from-purple-400 via-pink-500 to-red-600
- 音声: from-green-400 via-teal-500 to-blue-600

### 7.3 タイポグラフィ

- フォント: Noto Sans JP, Kosugi Maru
- 見出し: text-2xl md:text-3xl lg:text-4xl font-bold
- 本文: prose prose-base md:prose-lg

## 8. パフォーマンス最適化

- 必要なデータのみを取得
- 静的生成とサーバーサイドレンダリングの併用
- 画像の最適化

## 9. 今後の拡張性

- 新しいMDXコンポーネントの追加
- 検索機能の強化
- パーソナライゼーション機能の追加

## 10. テスト計画

- ユニットテスト: MDXユーティリティ関数のテスト
- 統合テスト: ページコンポーネントのテスト
- E2Eテスト: ユーザーフローのテスト

## 11. 移行計画

1. Contentfulのコンテンツモデルの更新
2. 既存のMDXコンテンツの移行
3. 関連コンテンツの設定
4. 新しいコンポーネントの実装
5. ページコンポーネントの更新
6. テストとデバッグ
7. 本番環境へのデプロイ
